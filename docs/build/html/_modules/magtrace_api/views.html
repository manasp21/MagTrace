

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>magtrace_api.views &mdash; MagTrace Pro 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MagTrace Pro
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id10">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id23">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id28">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id33">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id38">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id43">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id48">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id53">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id90">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#id95">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_results.html">}</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">}</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MagTrace Pro</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">magtrace_api.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for magtrace_api.views</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">action</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">MultiPartParser</span><span class="p">,</span> <span class="n">FormParser</span>
<span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">default_storage</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Dataset</span><span class="p">,</span> <span class="n">MagnetometerReading</span><span class="p">,</span> <span class="n">Label</span><span class="p">,</span> <span class="n">MLModel</span><span class="p">,</span> <span class="n">InferenceResult</span><span class="p">,</span> <span class="n">ActiveLearningSuggestion</span><span class="p">,</span>
    <span class="n">Project</span><span class="p">,</span> <span class="n">LabelCategory</span><span class="p">,</span> <span class="n">Annotation</span><span class="p">,</span> <span class="n">UserDefinedModel</span><span class="p">,</span> <span class="n">TrainingSession</span><span class="p">,</span> <span class="n">Prediction</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DatasetSerializer</span><span class="p">,</span> <span class="n">MagnetometerReadingSerializer</span><span class="p">,</span> <span class="n">LabelSerializer</span><span class="p">,</span>
    <span class="n">MLModelSerializer</span><span class="p">,</span> <span class="n">InferenceResultSerializer</span><span class="p">,</span> <span class="n">ActiveLearningSuggestionSerializer</span><span class="p">,</span>
    <span class="n">ProjectSerializer</span><span class="p">,</span> <span class="n">LabelCategorySerializer</span><span class="p">,</span> <span class="n">AnnotationSerializer</span><span class="p">,</span>
    <span class="n">UserDefinedModelSerializer</span><span class="p">,</span> <span class="n">UserDefinedModelSummarySerializer</span><span class="p">,</span> <span class="n">ModelVersionSerializer</span><span class="p">,</span>
    <span class="n">ModelRenameSerializer</span><span class="p">,</span> <span class="n">ModelCloneSerializer</span><span class="p">,</span> <span class="n">ModelMetadataSerializer</span><span class="p">,</span>
    <span class="n">TrainingSessionSerializer</span><span class="p">,</span> <span class="n">PredictionSerializer</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.ml_service</span> <span class="kn">import</span> <span class="n">ml_service</span>

<span class="c1"># For now, disable celery tasks and use direct execution</span>
<span class="n">train_model_task</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">generate_suggestions_task</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">run_inference_task</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="DatasetViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.DatasetViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">DatasetViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">DatasetSerializer</span>
    <span class="n">parser_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">MultiPartParser</span><span class="p">,</span> <span class="n">FormParser</span><span class="p">)</span>
    
<div class="viewcode-block" id="DatasetViewSet.upload">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.DatasetViewSet.upload">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">file</span> <span class="k">else</span> <span class="s1">&#39;Unnamed Dataset&#39;</span><span class="p">)</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No file provided&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Only CSV files are supported&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="c1"># Create dataset with project association</span>
        <span class="n">dataset_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">file</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">project_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
                <span class="n">dataset_data</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span>
            <span class="k">except</span> <span class="n">Project</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Project not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">dataset_data</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_csv_file</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DatasetViewSet.process_csv_file">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.DatasetViewSet.process_csv_file">[docs]</a>
    <span class="k">def</span> <span class="nf">process_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">path</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="c1"># Handle different column names for altitude</span>
        <span class="n">altitude_col</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;alt&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;altitude&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">altitude_col</span> <span class="o">=</span> <span class="s1">&#39;alt&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;altitude&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">altitude_col</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span>
        
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp_pc&#39;</span><span class="p">,</span> <span class="s1">&#39;b_x&#39;</span><span class="p">,</span> <span class="s1">&#39;b_y&#39;</span><span class="p">,</span> <span class="s1">&#39;b_z&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">altitude_col</span><span class="p">,</span> <span class="s1">&#39;thetax&#39;</span><span class="p">,</span> <span class="s1">&#39;thetay&#39;</span><span class="p">,</span> <span class="s1">&#39;thetaz&#39;</span><span class="p">,</span> <span class="s1">&#39;sensor_id&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span><span class="p">):</span>
            <span class="n">available_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV must contain columns: </span><span class="si">{</span><span class="n">required_columns</span><span class="si">}</span><span class="s2">. Available columns: </span><span class="si">{</span><span class="n">available_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">readings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">reading</span> <span class="o">=</span> <span class="n">MagnetometerReading</span><span class="p">(</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">timestamp_pc</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp_pc&#39;</span><span class="p">]),</span>
                <span class="n">b_x</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;b_x&#39;</span><span class="p">]),</span>
                <span class="n">b_y</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;b_y&#39;</span><span class="p">]),</span>
                <span class="n">b_z</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;b_z&#39;</span><span class="p">]),</span>
                <span class="n">lat</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]),</span>
                <span class="n">lon</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]),</span>
                <span class="n">altitude</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">altitude_col</span><span class="p">]),</span>  <span class="c1"># Use the detected altitude column</span>
                <span class="n">thetax</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;thetax&#39;</span><span class="p">]),</span>
                <span class="n">thetay</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;thetay&#39;</span><span class="p">]),</span>
                <span class="n">thetaz</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;thetaz&#39;</span><span class="p">]),</span>
                <span class="n">sensor_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sensor_id&#39;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">readings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span>
        
        <span class="n">MagnetometerReading</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">readings</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">total_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">readings</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="DatasetViewSet.data">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.DatasetViewSet.data">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">readings</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">readings</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">MagnetometerReadingSerializer</span><span class="p">(</span><span class="n">readings</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DatasetViewSet.statistics">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.DatasetViewSet.statistics">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">readings</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">readings</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">readings</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_records&#39;</span><span class="p">:</span> <span class="n">readings</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s1">&#39;sensors&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">readings</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;sensor_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()),</span>
            <span class="s1">&#39;time_range&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">readings</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp_pc</span><span class="p">,</span>
                <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">readings</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp_pc</span>
            <span class="p">},</span>
            <span class="s1">&#39;magnetic_field_stats&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;b_x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_stats</span><span class="p">(</span><span class="n">readings</span><span class="p">,</span> <span class="s1">&#39;b_x&#39;</span><span class="p">),</span>
                <span class="s1">&#39;b_y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_stats</span><span class="p">(</span><span class="n">readings</span><span class="p">,</span> <span class="s1">&#39;b_y&#39;</span><span class="p">),</span>
                <span class="s1">&#39;b_z&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_stats</span><span class="p">(</span><span class="n">readings</span><span class="p">,</span> <span class="s1">&#39;b_z&#39;</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s1">&#39;location_range&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;lat_min&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">readings</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="s1">&#39;lat_max&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">readings</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="s1">&#39;lon_min&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">readings</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="s1">&#39;lon_max&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">readings</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DatasetViewSet.get_field_stats">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.DatasetViewSet.get_field_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_field_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readings</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">readings</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="MagnetometerReadingViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.MagnetometerReadingViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">MagnetometerReadingViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">MagnetometerReading</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MagnetometerReadingSerializer</span>
    
<div class="viewcode-block" id="MagnetometerReadingViewSet.get_queryset">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.MagnetometerReadingViewSet.get_queryset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>
</div>



<div class="viewcode-block" id="LabelViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.LabelViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">LabelViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Label</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">LabelSerializer</span>
    
<div class="viewcode-block" id="LabelViewSet.bulk_create">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.LabelViewSet.bulk_create">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">bulk_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">labels_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No labels provided&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label_data</span> <span class="ow">in</span> <span class="n">labels_data</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">label_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MLModelViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.MLModelViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">MLModelViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">MLModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MLModelSerializer</span>
    
<div class="viewcode-block" id="MLModelViewSet.set_active">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.MLModelViewSet.set_active">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">set_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">MLModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="MLModelViewSet.train">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.MLModelViewSet.train">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly_detection&#39;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;dataset_id and name are required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Direct training (no Celery for now)</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">model_path</span> <span class="o">=</span> <span class="n">ml_service</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span>
                <span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span>
            <span class="p">)</span>
            
            <span class="c1"># Create model record in database</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
            <span class="n">ml_model</span> <span class="o">=</span> <span class="n">MLModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                <span class="n">training_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                <span class="n">model_file</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
                <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">ml_model</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;training_completed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Training </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> completed (</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backend&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;unknown&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> backend)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="MLModelViewSet.generate_suggestions">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.MLModelViewSet.generate_suggestions">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">generate_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;dataset_id is required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Direct suggestion generation (no Celery for now)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_file</span><span class="p">:</span>
                <span class="n">ml_service</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model_file</span><span class="p">)</span>
            
            <span class="c1"># Generate suggestions</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">ml_service</span><span class="o">.</span><span class="n">generate_active_learning_suggestions</span><span class="p">(</span>
                <span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">model_type</span>
            <span class="p">)</span>
            
            <span class="c1"># Save suggestions to database</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
            <span class="n">suggestion_objects</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">suggestion_obj</span> <span class="o">=</span> <span class="n">ActiveLearningSuggestion</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                    <span class="n">start_index</span><span class="o">=</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span>
                    <span class="n">end_index</span><span class="o">=</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span>
                    <span class="n">suggested_label</span><span class="o">=</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;suggestion&#39;</span><span class="p">],</span>
                    <span class="n">confidence</span><span class="o">=</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">suggestion_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suggestion_obj</span><span class="p">)</span>
            
            <span class="n">ActiveLearningSuggestion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">suggestion_objects</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;suggestions_generated&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">suggestion_objects</span><span class="p">)</span><span class="si">}</span><span class="s1"> suggestions&#39;</span><span class="p">,</span>
                <span class="s1">&#39;suggestions_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">suggestion_objects</span><span class="p">)</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="InferenceResultViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.InferenceResultViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">InferenceResultViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">InferenceResult</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">InferenceResultSerializer</span>
    
<div class="viewcode-block" id="InferenceResultViewSet.run_inference">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.InferenceResultViewSet.run_inference">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">run_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;dataset_id and model_id are required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Direct inference (no Celery for now)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">MLModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">model_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_file</span><span class="p">:</span>
                <span class="n">ml_service</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model_file</span><span class="p">)</span>
            
            <span class="c1"># Load dataset</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
            <span class="n">readings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">readings</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;timestamp_pc&#39;</span><span class="p">))</span>
            
            <span class="c1"># Run inference</span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">confidence_scores</span> <span class="o">=</span> <span class="n">ml_service</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">readings</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">model_type</span>
            <span class="p">)</span>
            
            <span class="c1"># Save results</span>
            <span class="n">inference_result</span> <span class="o">=</span> <span class="n">InferenceResult</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
                <span class="n">confidence_scores</span><span class="o">=</span><span class="n">confidence_scores</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;inference_result_id&#39;</span><span class="p">:</span> <span class="n">inference_result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;inference_completed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Inference completed with </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;predictions_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ActiveLearningSuggestionViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.ActiveLearningSuggestionViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">ActiveLearningSuggestionViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">ActiveLearningSuggestion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ActiveLearningSuggestionSerializer</span>
    
<div class="viewcode-block" id="ActiveLearningSuggestionViewSet.accept">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.ActiveLearningSuggestionViewSet.accept">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">suggestion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        
        <span class="n">Label</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">suggestion</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">start_index</span><span class="o">=</span><span class="n">suggestion</span><span class="o">.</span><span class="n">start_index</span><span class="p">,</span>
            <span class="n">end_index</span><span class="o">=</span><span class="n">suggestion</span><span class="o">.</span><span class="n">end_index</span><span class="p">,</span>
            <span class="n">label_type</span><span class="o">=</span><span class="n">suggestion</span><span class="o">.</span><span class="n">suggested_label</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">suggestion</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
            <span class="n">created_by</span><span class="o">=</span><span class="s1">&#39;active_learning&#39;</span>
        <span class="p">)</span>
        
        <span class="n">suggestion</span><span class="o">.</span><span class="n">reviewed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">suggestion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;accepted&#39;</span><span class="p">})</span></div>

    
<div class="viewcode-block" id="ActiveLearningSuggestionViewSet.reject">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.ActiveLearningSuggestionViewSet.reject">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">suggestion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">suggestion</span><span class="o">.</span><span class="n">reviewed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">suggestion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;rejected&#39;</span><span class="p">})</span></div>
</div>



<span class="c1"># Enhanced Model ViewSets</span>
<div class="viewcode-block" id="ProjectViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.ProjectViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">ProjectViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ProjectSerializer</span>
    
<div class="viewcode-block" id="ProjectViewSet.export">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.ProjectViewSet.export">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.project_service</span> <span class="kn">import</span> <span class="n">ProjectService</span>
        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">ProjectService</span><span class="o">.</span><span class="n">export_project</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;download_url&#39;</span><span class="p">:</span> <span class="n">zip_path</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Project exported successfully&#39;</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="ProjectViewSet.import_project">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.ProjectViewSet.import_project">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">import_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.project_service</span> <span class="kn">import</span> <span class="n">ProjectService</span>
        
        <span class="n">zip_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zip_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;project_file is required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">ProjectService</span><span class="o">.</span><span class="n">import_project</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LabelCategoryViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.LabelCategoryViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">LabelCategoryViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">LabelCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">LabelCategorySerializer</span>
    
<div class="viewcode-block" id="LabelCategoryViewSet.get_queryset">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.LabelCategoryViewSet.get_queryset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>
</div>



<div class="viewcode-block" id="AnnotationViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.AnnotationViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">AnnotationViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;start_index&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">AnnotationSerializer</span>
    
<div class="viewcode-block" id="AnnotationViewSet.get_queryset">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.AnnotationViewSet.get_queryset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>
</div>



<div class="viewcode-block" id="UserDefinedModelViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">UserDefinedModelViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">UserDefinedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-updated_at&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserDefinedModelSerializer</span>
    
<div class="viewcode-block" id="UserDefinedModelViewSet.get_queryset">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.get_queryset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_id&#39;</span><span class="p">)</span>
        <span class="n">summary_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        
        <span class="k">if</span> <span class="n">project_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
        
        <span class="c1"># Filter by tags if provided</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">tag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">:</span>
                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__contains</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
        
        <span class="c1"># Filter by category</span>
        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category__icontains</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">queryset</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.get_serializer_class">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.get_serializer_class">[docs]</a>
    <span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UserDefinedModelSummarySerializer</span>
        <span class="k">return</span> <span class="n">UserDefinedModelSerializer</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.script_template">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.script_template">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">script_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.user_script_service</span> <span class="kn">import</span> <span class="n">UserScriptService</span>
        
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span> <span class="s1">&#39;classification&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">UserScriptService</span><span class="o">.</span><span class="n">get_script_template</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
            <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="n">model_type</span>
        <span class="p">})</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.validate_script">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.validate_script">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">validate_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.user_script_service</span> <span class="kn">import</span> <span class="n">UserScriptService</span>
        
        <span class="n">script</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">UserScriptService</span><span class="o">.</span><span class="n">validate_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="n">is_valid</span><span class="p">,</span>
                <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">errors</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.rename">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.rename">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename a model and optionally all its versions&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ModelRenameSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;new_name&#39;</span><span class="p">]</span>
        <span class="n">update_all_versions</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;update_all_versions&#39;</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_all_versions</span><span class="p">:</span>
                <span class="c1"># Update all versions</span>
                <span class="n">all_versions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_versions</span><span class="p">()</span>
                <span class="n">all_versions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">new_name</span><span class="p">)</span>
                <span class="n">updated_count</span> <span class="o">=</span> <span class="n">all_versions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Update only this version</span>
                <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">updated_count</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Successfully renamed </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s1"> model(s) to &quot;</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;updated_count&#39;</span><span class="p">:</span> <span class="n">updated_count</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.clone">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.clone">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clone a model with a new name&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ModelCloneSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;new_name&#39;</span><span class="p">]</span>
        <span class="n">clone_version</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;clone_version&#39;</span><span class="p">]</span>
        <span class="n">clone_notes</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clone_notes&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">include_training_data</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;include_training_data&#39;</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create cloned model</span>
            <span class="n">cloned_model</span> <span class="o">=</span> <span class="n">UserDefinedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">project</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">new_name</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cloned from </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">python_script</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">python_script</span><span class="p">,</span>
                <span class="n">hyperparameters</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">version</span><span class="o">=</span><span class="n">clone_version</span><span class="p">,</span>
                <span class="n">version_notes</span><span class="o">=</span><span class="n">clone_notes</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">category</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
                <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="k">else</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                <span class="n">custom_metadata</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">custom_metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">include_training_data</span><span class="p">:</span>
                <span class="n">cloned_model</span><span class="o">.</span><span class="n">training_datasets</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">training_datasets</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">cloned_model</span><span class="o">.</span><span class="n">performance_metrics</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">performance_metrics</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">cloned_model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserDefinedModelSerializer</span><span class="p">(</span><span class="n">cloned_model</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.create_version">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.create_version">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">create_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new version of a model&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        
        <span class="n">version_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
        <span class="n">version_notes</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version_notes&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_version</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create_new_version</span><span class="p">(</span><span class="n">version_number</span><span class="p">,</span> <span class="n">version_notes</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserDefinedModelSerializer</span><span class="p">(</span><span class="n">new_version</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.versions">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.versions">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all versions of a model&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_versions</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ModelVersionSerializer</span><span class="p">(</span><span class="n">versions</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.generate_intelligent_name">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.generate_intelligent_name">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">generate_intelligent_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate intelligent model name based on training data and labels&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.training_service</span> <span class="kn">import</span> <span class="n">training_orchestrator</span>
        
        <span class="n">dataset_ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span> <span class="s1">&#39;classification&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;dataset_ids is required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Analyze datasets and generate name</span>
            <span class="n">name_suggestion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_model_name</span><span class="p">(</span><span class="n">dataset_ids</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;suggested_name&#39;</span><span class="p">:</span> <span class="n">name_suggestion</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">name_suggestion</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                <span class="s1">&#39;suggested_tags&#39;</span><span class="p">:</span> <span class="n">name_suggestion</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
                <span class="s1">&#39;suggested_category&#39;</span><span class="p">:</span> <span class="n">name_suggestion</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_generate_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_ids</span><span class="p">,</span> <span class="n">model_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate intelligent model name based on dataset analysis&quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">dataset_ids</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No valid datasets found&quot;</span><span class="p">)</span>
        
        <span class="c1"># Analyze datasets</span>
        <span class="n">total_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">label_categories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">dataset_names</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="n">total_samples</span> <span class="o">+=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">total_records</span>
            <span class="n">dataset_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            
            <span class="c1"># Get label categories from annotations</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
                <span class="n">label_categories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        
        <span class="c1"># Generate descriptive name components</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_categories</span><span class="p">)</span>
        
        <span class="c1"># Determine primary label types</span>
        <span class="k">if</span> <span class="s1">&#39;anomaly&#39;</span> <span class="ow">in</span> <span class="n">unique_labels</span> <span class="ow">or</span> <span class="s1">&#39;normal&#39;</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
            <span class="n">label_focus</span> <span class="o">=</span> <span class="s1">&#39;anomaly_detector&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;fan_noise&#39;</span> <span class="ow">in</span> <span class="n">unique_labels</span> <span class="ow">or</span> <span class="s1">&#39;motor&#39;</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
            <span class="n">label_focus</span> <span class="o">=</span> <span class="s1">&#39;interference_classifier&#39;</span> 
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">label_focus</span> <span class="o">=</span> <span class="s1">&#39;multi_class_classifier&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_focus</span> <span class="o">=</span> <span class="s1">&#39;magnetic_classifier&#39;</span>
        
        <span class="c1"># Generate base name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_focus</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datasets</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_focus</span><span class="si">}</span><span class="s2">_multi_dataset&quot;</span>
        
        <span class="c1"># Create version-specific elements</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span> <span class="k">if</span> <span class="n">total_samples</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="k">else</span> <span class="s2">&quot;standard&quot;</span>
        
        <span class="c1"># Generate full name</span>
        <span class="n">suggested_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Generate description</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">label_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s2"> more&quot;</span>
        
        <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> model trained on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> dataset(s) &quot;</span> \
                     <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="n">total_samples</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> samples. Detects: </span><span class="si">{</span><span class="n">label_str</span><span class="si">}</span><span class="s2">.&quot;</span>
        
        <span class="c1"># Generate tags</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">,</span> <span class="s1">&#39;magnetic_field&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;multi_dataset&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_samples</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;large_scale&#39;</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># Add top 3 label types</span>
        
        <span class="c1"># Generate category</span>
        <span class="k">if</span> <span class="s1">&#39;anomaly&#39;</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;Anomaly Detection&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;Multi-Class Classification&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;Binary Classification&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">suggested_name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span>
        <span class="p">}</span>
    
<div class="viewcode-block" id="UserDefinedModelViewSet.update_metadata">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.update_metadata">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update model metadata (tags, category, author, custom_metadata)&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ModelMetadataSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="c1"># Update metadata fields</span>
        <span class="k">if</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">in</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;author&#39;</span> <span class="ow">in</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;custom_metadata&#39;</span> <span class="ow">in</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">custom_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s1">&#39;custom_metadata&#39;</span><span class="p">])</span>
        
        <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="c1"># Return updated model</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserDefinedModelSerializer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.categories">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.categories">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">categories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all unique categories&quot;&quot;&quot;</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_id&#39;</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">UserDefinedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">project_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
        
        <span class="n">categories</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">categories</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="UserDefinedModelViewSet.tags">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.UserDefinedModelViewSet.tags">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all unique tags&quot;&quot;&quot;</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_id&#39;</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">UserDefinedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">project_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
        
        <span class="c1"># Extract all tags from all models</span>
        <span class="n">all_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">all_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_tags</span><span class="p">)))</span></div>
</div>



<div class="viewcode-block" id="TrainingSessionViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.TrainingSessionViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">TrainingSessionViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">TrainingSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_at&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">TrainingSessionSerializer</span>
    
<div class="viewcode-block" id="TrainingSessionViewSet.get_queryset">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.TrainingSessionViewSet.get_queryset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

    
<div class="viewcode-block" id="TrainingSessionViewSet.start_training">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.TrainingSessionViewSet.start_training">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">start_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start training with simplified, working training system&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.simple_training_service</span> <span class="kn">import</span> <span class="n">simple_training_orchestrator</span>
        
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        <span class="n">additional_dataset_ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;additional_dataset_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">continue_from_session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;continue_from_session&#39;</span><span class="p">)</span>
        <span class="n">training_config</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;training_config&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dataset_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;model_id and dataset_id are required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start simple training that actually works</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">simple_training_orchestrator</span><span class="o">.</span><span class="n">start_training</span><span class="p">(</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                <span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
                <span class="n">training_config</span><span class="o">=</span><span class="n">training_config</span>
            <span class="p">)</span>
            
            <span class="c1"># Get the created session</span>
            <span class="n">training_session</span> <span class="o">=</span> <span class="n">TrainingSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">training_session</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="TrainingSessionViewSet.stop_training">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.TrainingSessionViewSet.stop_training">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">stop_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop an active training session&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.simple_training_service</span> <span class="kn">import</span> <span class="n">simple_training_orchestrator</span>
        
        <span class="n">training_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">simple_training_orchestrator</span><span class="o">.</span><span class="n">cancel_training</span><span class="p">(</span><span class="n">training_session</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">training_session</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
                <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">training_session</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Training session not found or not active&#39;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="TrainingSessionViewSet.status">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.TrainingSessionViewSet.status">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get real-time training status and progress&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.simple_training_service</span> <span class="kn">import</span> <span class="n">simple_training_orchestrator</span>
        
        <span class="n">training_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">status_info</span> <span class="o">=</span> <span class="n">simple_training_orchestrator</span><span class="o">.</span><span class="n">get_training_status</span><span class="p">(</span><span class="n">training_session</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_info</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TrainingSessionViewSet.active_sessions">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.TrainingSessionViewSet.active_sessions">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">active_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all currently active training sessions&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.simple_training_service</span> <span class="kn">import</span> <span class="n">simple_training_orchestrator</span>
        
        <span class="n">active_session_ids</span> <span class="o">=</span> <span class="n">simple_training_orchestrator</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">()</span>
        <span class="n">active_sessions</span> <span class="o">=</span> <span class="n">TrainingSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">active_session_ids</span><span class="p">)</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">active_sessions</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PredictionViewSet">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.PredictionViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">PredictionViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Prediction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_at&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PredictionSerializer</span>
    
<div class="viewcode-block" id="PredictionViewSet.get_queryset">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.PredictionViewSet.get_queryset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dataset_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">queryset</span></div>

    
<div class="viewcode-block" id="PredictionViewSet.review">
<a class="viewcode-back" href="../../index.html#magtrace_api.views.PredictionViewSet.review">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">review</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        
        <span class="n">review_status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>  <span class="c1"># &#39;accepted&#39;, &#39;rejected&#39;, &#39;modified&#39;</span>
        <span class="n">reviewed_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reviewed_by&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">modifications</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modifications&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="n">review_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid review status&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="n">prediction</span><span class="o">.</span><span class="n">review_status</span> <span class="o">=</span> <span class="n">review_status</span>
        <span class="n">prediction</span><span class="o">.</span><span class="n">reviewed_by</span> <span class="o">=</span> <span class="n">reviewed_by</span>
        <span class="n">prediction</span><span class="o">.</span><span class="n">reviewed_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">review_status</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
            <span class="n">prediction</span><span class="o">.</span><span class="n">modifications</span> <span class="o">=</span> <span class="n">modifications</span>
        
        <span class="n">prediction</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Manas Pandey.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>